<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nyam.model.dao.ArticleDao">
	<insert id="insertArticleMaster" parameterType="ArticleMaster" keyColumn="id" keyProperty="id" useGeneratedKeys="true">
		INSERT INTO article_master (
			user_id
		  , type
		  , image_id
		  , content
		  , ingredient
		) values (
			#{userId}
		  , #{type}
		  , #{imageId}
		  , #{content}
		  , #{ingredient}
		)
	</insert>
	
	<insert id="insertArticleDetail" parameterType="ArticleDetail" keyColumn="id" keyProperty="id" useGeneratedKeys="true">
		INSERT INTO article_detail (
			article_id
		  , `order`
		  , image_id
		  , content
		) values (
			#{articleId}
		  , #{order}
		  , #{imageId}
		  , #{content}
		)
	</insert>
	
	<select id="selectArticleMaster" resultType="ArticleMaster">
		SELECT a.id
		     , a.user_id
		     , u.name as user_name
		     , a.type
		     , a.image_id
		     , a.content
		     , a.ingredient
		     , i.org_file as image_url
		  FROM article_master a
		     , image i
		     , user u
		 WHERE a.id = #{id}
		   AND a.image_id = i.id
		   AND a.use_yn = 'Y'
		   AND a.user_id = u.user_id
	</select>
	
	<select id="selectArticleMasterAll" resultType="ArticleMaster">
		SELECT a.id
		     , a.user_id
		     , u.name as user_name
		     , ui.org_file as user_image
		     , a.type
		     , a.image_id
		     , ai.org_file as image_url
		  FROM article_master a 
		     , image ai
		     , user u
		  LEFT OUTER JOIN image ui ON ui.ID = u.IMAGE_ID
		 WHERE a.image_id = ai.id
		   AND a.use_yn = 'Y'
		   AND a.user_id = u.user_id
		 ORDER BY a.rgst_dttm desc
	</select>
	
	<update id="updateArticleMaster" parameterType="ArticleMaster">
		UPDATE article_master
		   SET user_id     = #{userId}
		     , image_id    = #{imageId}
		     , content     = #{content}
		     , ingredient  = #{ingredient}
		     , mdfc_dttm   = now()
		 WHERE id          = #{id}
	</update>
	
	<update id="deleteArticleMaster" parameterType="int">
		UPDATE article_master
		   SET use_yn = 'N'
		 WHERE id = #{id}
	</update>
	
	<select id="selectArticleDetail" parameterType="int">
		SELECT a.id
		     , a.article_id
		     , a.order
		     , a.image_id
		     , a.content
		     , i.org_file as image_url
		  FROM article_detail a
		     , image i
		 WHERE a.article_id = #{id}
		   AND a.use_yn = 'Y'
		   AND a.image_id = i.id
		 ORDER BY 'a.order' ASC
	</select>
	
	<select id="selectArticleMasterByUser" resultType="ArticleMaster">
		SELECT a.id
		     , a.user_id
		     , a.type
		     , a.image_id
		     , a.content
		     , a.ingredient
		     , i.org_file as image_url
		  FROM article_master a
		     , image i
		 WHERE a.user_id = #{userId}
		   AND a.image_id = i.id
		   AND a.use_yn = 'Y'
	</select>
	
	<insert id="insertComment" parameterType="ArticleComment" keyColumn="id" keyProperty="id" useGeneratedKeys="true">
		INSERT INTO article_comment (
			article_id
		  , user_id
		  , content
		) VALUES (
			#{articleId}
		  , #{userId}
		  , #{content}
		)
	</insert>
	
	<delete id="deleteComment" parameterType="int">
		UPDATE comment
		   SET use_yn = 'N'
		 WHERE id = #{id}
	</delete>
	
	<select id="selectComment" parameterType="int">
		SELECT c.id
		     , c.user_id
		     , u.name as user_name
		     , i.org_file as user_image
		     , c.article_id
		     , c.content
		  FROM article_comment c
		     , user u
		  LEFT OUTER JOIN image i ON u.image_id = i.id
		 WHERE c.article_id = #{articleId}
		   AND c.user_id = u.user_id
		   AND c.use_yn = 'Y'
		 ORDER BY c.rgst_dttm asc;
	</select>
	
	<select id="selectArticleRecommend">
		WITH current_interactions AS (
		  -- 현재 사용자가 좋아요 또는 댓글로 상호작용한 게시물 목록
		  SELECT article_id 
		  FROM article_like 
		  WHERE user_id = #{user_id} AND use_yn = 'Y'
		  UNION
		  SELECT article_id 
		  FROM article_comment 
		  WHERE user_id = #{user_id} AND use_yn = 'Y'
		),
		similar_users AS (
		  -- 현재 사용자가 상호작용한 게시물에 대해, 다른 사용자들이 남긴 행동으로 유사 사용자 도출
		  SELECT DISTINCT user_id
		  FROM (
		    SELECT user_id 
		    FROM article_like 
		    WHERE article_id IN (SELECT article_id FROM current_interactions)
		      AND user_id != #{user_id}
		      AND use_yn = 'Y'
		    UNION
		    SELECT user_id 
		    FROM article_comment 
		    WHERE article_id IN (SELECT article_id FROM current_interactions)
		      AND user_id != #{user_id}
		      AND use_yn = 'Y'
		  ) AS sim
		),
		candidate_interactions AS (
		  SELECT article_id, 1 AS weight
		  FROM article_like
		  WHERE user_id IN (SELECT user_id FROM similar_users)
		    AND article_id NOT IN (SELECT article_id FROM current_interactions)
		    AND use_yn = 'Y'
		  UNION ALL
		  SELECT article_id, 1 AS weight  -- 댓글의 경우 필요시 가중치를 다르게 줄 수 있음 (예: 2)
		  FROM article_comment
		  WHERE user_id IN (SELECT user_id FROM similar_users)
		    AND article_id NOT IN (SELECT article_id FROM current_interactions)
		    AND use_yn = 'Y'
		),
		candidate_result AS (
		  SELECT am.*, SUM(ci.weight) AS score
		  FROM candidate_interactions ci
		  JOIN article_master am ON am.id = ci.article_id
		  WHERE am.use_yn = 'Y' 
		    AND am.id <![CDATA[<]]> #{top_id}
		  GROUP BY ci.article_id
		),
		fallback_popular AS (
		  SELECT am.*, (am.like_count + IFNULL(ac.comment_count, 0)) AS score
		  FROM article_master am
		  LEFT JOIN (
		      SELECT article_id, COUNT(*) AS comment_count
		      FROM article_comment
		      WHERE use_yn = 'Y'
		      GROUP BY article_id
		  ) ac ON am.id = ac.article_id
		  WHERE am.use_yn = 'Y'
		    AND am.id <![CDATA[<]]> #{top_id}
		  ORDER BY am.id DESC
		  LIMIT 20
		)
		SELECT * FROM candidate_result
		UNION ALL
		SELECT * FROM fallback_popular
		WHERE NOT EXISTS (SELECT 1 FROM candidate_result)
		ORDER BY id DESC;
	</select>
</mapper>